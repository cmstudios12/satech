<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Auth | SATECH ENTERPRISE</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --navy:#0b1c2d;
  --blue:#1e5eff;
  --green:#2ecc71;
  --red:#e74c3c;
  --radius:16px;
  --muted:#f4f6f8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,system-ui;
  background:linear-gradient(135deg,#f8fbff,#eef4ff);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:1rem;
}

.auth-box{
  background:#fff;
  width:100%;
  max-width:420px;
  padding:2rem;
  border-radius:var(--radius);
  box-shadow:0 25px 60px rgba(0,0,0,.1);
}
.logo{
  display:block;
  margin:auto;
  height:42px;
  margin-bottom:1rem;
}

.tabs{
  display:flex;
  background:var(--muted);
  border-radius:50px;
  margin-bottom:1.2rem;
}
.tab{
  flex:1;
  padding:.7rem;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  font-size:.9rem;
  border-radius:50px;
}
.tab.active{
  background:var(--blue);
  color:#fff;
}

.field{margin-bottom:.8rem}
.field input,.field select{
  width:100%;
  padding:.75rem;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:.9rem;
}

button{
  width:100%;
  padding:.85rem;
  border:none;
  border-radius:14px;
  background:var(--navy);
  color:#fff;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:.5rem;
  cursor:pointer;
}
button:disabled{opacity:.7;cursor:not-allowed}
.hidden{display:none}

.loader{
  width:18px;height:18px;
  border-radius:50%;
  border:3px solid #fff;
  border-top:3px solid transparent;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#fff;
  min-width:260px;
  max-width:340px;
  padding:.9rem 1rem;
  border-radius:14px;
  box-shadow:0 15px 40px rgba(0,0,0,.15);
  display:flex;
  gap:.7rem;
  z-index:9999;
  animation:slide .4s ease;
}
.toast.success{border-left:5px solid var(--green)}
.toast.error{border-left:5px solid var(--red)}
.toast.info{border-left:5px solid var(--blue)}
.toast i{font-size:1.2rem}
.toast.success i{color:var(--green)}
.toast.error i{color:var(--red)}
.toast.info i{color:var(--blue)}
.toast-title{font-weight:700}
.toast-msg{font-size:.8rem}
@keyframes slide{
  from{opacity:0;transform:translateY(-10px)}
  to{opacity:1;transform:translateY(0)}
}

@media(max-width:480px){
  .auth-box{padding:1.5rem}
  .toast{left:50%;right:auto;transform:translateX(-50%)}
}
</style>
</head>

<body>

<div class="auth-box">
  <img src="logo.png" class="logo" alt="Logo">

  <div class="tabs">
    <div class="tab active" id="loginTab">Sign In</div>
    <div class="tab" id="signupTab">Sign Up</div>
  </div>

  <form id="loginForm">
    <div class="field"><input type="email" id="loginEmail" placeholder="Email" required></div>
    <div class="field"><input type="password" id="loginPassword" placeholder="Password" required></div>
    <button type="submit">
      <span class="btn-text">Sign In</span>
      <span class="loader hidden"></span>
    </button>
  </form>

  <form id="signupForm" class="hidden">
    <div class="field"><input id="fullNames" placeholder="Full Names" required></div>
    <div class="field"><input id="surname" placeholder="Surname" required></div>

    <div class="field">
      <select id="gender" required>
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
    </div>

    <div class="field"><input type="email" id="signupEmail" placeholder="Email" required></div>
    <div class="field"><input id="phone" placeholder="Phone (06/07/08...)" required></div>
    <div class="field"><input type="password" id="signupPassword" placeholder="Password (min 6)" required></div>
    <div class="field"><input type="password" id="confirmPassword" placeholder="Confirm Password" required></div>

    <button type="submit">
      <span class="btn-text">Create Account</span>
      <span class="loader hidden"></span>
    </button>
  </form>
</div>

<script>
  const supabaseClient = supabase.createClient(
    "https://nzuwmiyduragtqyaetfr.supabase.co",
    "sb_publishable_0VN3EDApVH9bzKu2eH7fvg_5JfYOGMh"
  );

  function toast(type, title, msg) {
    const t = document.createElement("div");
    t.className = `toast ${type}`;
    t.innerHTML = `
      <i class="fa-solid ${
        type === "success" ? "fa-circle-check" :
        type === "info" ? "fa-circle-info" :
        "fa-triangle-exclamation"
      }"></i>
      <div>
        <div class="toast-title">${title}</div>
        <div class="toast-msg">${msg}</div>
      </div>`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 4500);
  }

  const loginTab = document.getElementById("loginTab");
  const signupTab = document.getElementById("signupTab");
  const loginForm = document.getElementById("loginForm");
  const signupForm = document.getElementById("signupForm");

  loginTab.onclick = () => {
    loginForm.classList.remove("hidden");
    signupForm.classList.add("hidden");
    loginTab.classList.add("active");
    signupTab.classList.remove("active");
  };

  signupTab.onclick = () => {
    signupForm.classList.remove("hidden");
    loginForm.classList.add("hidden");
    signupTab.classList.add("active");
    loginTab.classList.remove("active");
  };

  function loading(form, on) {
    const btn = form.querySelector("button");
    btn.disabled = on;
    btn.querySelector(".btn-text").classList.toggle("hidden", on);
    btn.querySelector(".loader").classList.toggle("hidden", !on);
  }

  function clean(str){ return (str ?? "").toString().trim(); }
  function validPhone(p){ return /^[0-9+\s-]{9,15}$/.test(p); }

  // ✅ SIGNUP (metadata -> DB trigger creates profile)
  signupForm.onsubmit = async (e) => {
    e.preventDefault();

    const full_names = clean(document.getElementById("fullNames").value);
    const surname = clean(document.getElementById("surname").value);
    const gender = clean(document.getElementById("gender").value);
    const email = clean(document.getElementById("signupEmail").value);
    const phone = clean(document.getElementById("phone").value);
    const password = document.getElementById("signupPassword").value;
    const confirm = document.getElementById("confirmPassword").value;

    if (!full_names || !surname || !gender || !email || !phone) {
      return toast("error", "Missing Info", "Please fill in all fields.");
    }
    if (!validPhone(phone)) {
      return toast("error", "Invalid Phone", "Please enter a valid phone number.");
    }
    if (password.length < 6) {
      return toast("error", "Weak Password", "Password must be at least 6 characters.");
    }
    if (password !== confirm) {
      return toast("error", "Passwords Don't Match", "Please confirm your password correctly.");
    }

    loading(signupForm, true);

    const { data, error } = await supabaseClient.auth.signUp({
      email,
      password,
      options: {
        data: { full_names, surname, phone, gender }
      }
    });

    loading(signupForm, false);

    if (error) return toast("error", "Signup Failed", error.message);

    toast("success", "Account Created", "Check your email to confirm (if required), then sign in.");
    setTimeout(() => loginTab.click(), 1200);
  };

  // ✅ LOGIN (fetch profile correctly + no default Ms)
  loginForm.onsubmit = async (e) => {
    e.preventDefault();

    const email = clean(document.getElementById("loginEmail").value);
    const password = document.getElementById("loginPassword").value;

    loading(loginForm, true);

    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

    if (error) {
      loading(loginForm, false);
      const msg = (error.message || "").toLowerCase();
      if (msg.includes("confirm") || msg.includes("confirmed")) {
        return toast("error", "Email Not Confirmed", "Please confirm your email before logging in.");
      }
      return toast("error", "Login Failed", error.message);
    }

    const { data: profile, error: profileError } = await supabaseClient
      .from("profiles")
      .select("surname, full_names, gender")
      .eq("id", data.user.id)
      .maybeSingle();

    loading(loginForm, false);

    if (profileError || !profile) {
      toast("success", "Welcome", "Welcome! Redirecting…");
      return setTimeout(() => location.href = "dashboard.html", 1200);
    }

    let title = "Welcome";
    if (profile.gender === "Male") title = "Mr";
    else if (profile.gender === "Female") title = "Ms";

    const displayName = profile.surname || profile.full_names || "";
    toast("success", "Welcome", displayName ? `Welcome ${title} ${displayName}` : `Welcome ${title}`);

    setTimeout(() => location.href = "dashboard.html", 1400);
  };
</script>

</body>
</html>
