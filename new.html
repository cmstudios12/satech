<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New Laptops | SATECH ENTERPRISE</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --navy:#0b1c2d;
      --blue:#1e5eff;
      --light:#f8f9fa;
      --white:#fff;
      --muted:#f4f6f8;
      --radius:16px;
      --red:#e74c3c;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI',system-ui,sans-serif; }
    body{ background:var(--light); color:#111; line-height:1.6; }
    a{ text-decoration:none; color:inherit; }
    img{ max-width:100%; display:block; }

    /* ===== HEADER (Dashboard style) ===== */
    header{
      position: sticky;
      top: 0;
      z-index: 2000;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #e5e7eb;
    }

    .nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:1200px;
      margin:auto;
      padding:1rem;
      gap:1rem;
    }

    .brand img.logo{ height:48px; max-width:160px; }

    /* Desktop nav */
    .nav-links{
      display:flex;
      align-items:center;
      gap:1.3rem;
    }

    .nav-links a{
      position:relative;
      padding:.25rem 0;
      font-weight:600;
      color:var(--navy);
      opacity:.92;
    }
    .nav-links a::after{
      content:"";
      position:absolute;
      left:0; bottom:-2px;
      width:0; height:2px;
      background:var(--blue);
      transition:.25s;
    }
    .nav-links a:hover::after{ width:100%; }

    /* Actions */
    .nav-actions{
      display:flex;
      align-items:center;
      gap:10px;
      position:relative;
    }

    .icon-btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:var(--navy);
      cursor:pointer;
      transition:.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .icon-btn:hover{ border-color:#cbd5e1; transform:translateY(-1px); }
    .icon-btn i{ font-size:1.1rem; }

    .badge{
      position:absolute;
      top:-7px; right:-7px;
      min-width:20px; height:20px;
      padding:0 6px;
      border-radius:999px;
      background:var(--blue);
      color:#fff;
      font-size:.75rem;
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #fff;
    }
    .badge.red{ background:var(--red); }

    .user-initials{
      width:44px; height:44px;
      border-radius:50%;
      background:var(--blue);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .user-menu{
      position:absolute;
      top:115%;
      right:0;
      min-width:220px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.08);
      overflow:hidden;
      display:none;
      z-index:2205;
    }
    .user-menu a{
      display:flex;
      align-items:center;
      gap:.7rem;
      padding:.85rem 1rem;
      font-weight:800;
      color:var(--navy);
    }
    .user-menu a i{ color:var(--blue); }
    .user-menu a:hover{ background:var(--muted); }

    /* Professional Hamburger + Drawer (Dashboard style) */
    .hamburger{
      display:none;
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#fff;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:.2s;
      z-index:2200;
      position:relative;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .hamburger:hover{ border-color:#cbd5e1; }

    .hamburger-lines{ width:18px; height:12px; position:relative; }
    .hamburger-lines span{
      position:absolute; left:0;
      width:100%; height:2px;
      background:var(--navy);
      border-radius:999px;
      transition:.25s ease;
    }
    .hamburger-lines span:nth-child(1){ top:0; }
    .hamburger-lines span:nth-child(2){ top:5px; }
    .hamburger-lines span:nth-child(3){ top:10px; }

    .hamburger.active .hamburger-lines span:nth-child(1){ transform:translateY(5px) rotate(45deg); }
    .hamburger.active .hamburger-lines span:nth-child(2){ opacity:0; transform:translateX(6px); }
    .hamburger.active .hamburger-lines span:nth-child(3){ transform:translateY(-5px) rotate(-45deg); }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition:.25s ease;
      z-index:2050;
    }
    .overlay.show{
      opacity:1;
      pointer-events:auto;
    }

    .mobile-drawer{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:min(360px, 86vw);
      background:#fff;
      border-left:1px solid #e5e7eb;
      transform:translateX(105%);
      transition:.28s ease;
      z-index:2060;
      display:flex;
      flex-direction:column;
    }
    .mobile-drawer.show{ transform:translateX(0); }

    .drawer-head{
      padding:1rem;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
    }
    .drawer-head strong{ color:var(--navy); font-size:1rem; }

    .drawer-close{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .drawer-body{
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:.65rem;
    }

    .drawer-link{
      padding:.95rem 1rem;
      border-radius:14px;
      border:1px solid #eef2f7;
      background:#fbfdff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:900;
      color:var(--navy);
    }
    .drawer-link span{
      display:inline-flex;
      align-items:center;
      gap:.6rem;
    }
    .drawer-link i{ color:var(--blue); }

    .drawer-footer{
      margin-top:auto;
      padding:1rem;
      border-top:1px solid #e5e7eb;
      color:#6b7280;
      font-size:.85rem;
      line-height:1.3;
    }

    body.no-scroll{ overflow:hidden; height:100vh; }

    @media(max-width: 900px){
      .nav-links{ display:none; }
      .hamburger{ display:inline-flex; }
    }

    /* ===== HERO ===== */
    .page-header{
      background: linear-gradient(135deg, #f8fbff, #eef4ff);
      padding: 2.8rem 1.5rem;
    }
    .hero-container{
      max-width:1200px;
      margin:auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:2.5rem;
      align-items:center;
    }
    .hero-text h1{
      font-size:2.6rem;
      color:var(--navy);
      letter-spacing:-.02em;
    }
    .hero-text p{ margin-top:1rem; color:#555; max-width:55ch; }
    .hero-image img{ width:100%; max-width:480px; }

    @media(max-width: 900px){
      .hero-container{ grid-template-columns:1fr; text-align:left; }
      .hero-text h1{ font-size:2rem; }
      .hero-image{ order:-1; }
    }

    /* ===== PRODUCTS ===== */
    .container{
      max-width:1200px;
      margin:auto;
      padding: 3.2rem 1.5rem 4rem;
    }
    .section-title{
      font-size:2rem;
      color:var(--navy);
      margin-bottom:1.4rem;
    }

    .products{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap:1.5rem;
    }

    .product{
      border:1px solid #e5e7eb;
      border-radius:var(--radius);
      background:#fff;
      padding:1.2rem;
      display:flex;
      flex-direction:column;
      transition:.2s;
      overflow:hidden;
      min-height:320px;
    }
    .product:hover{
      box-shadow:0 18px 40px rgba(0,0,0,.06);
      transform:translateY(-2px);
    }

    .product-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:.8rem;
    }

    .fav-btn{
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .fav-btn i{ color:#94a3b8; font-size:1.05rem; }
    .fav-btn.active{
      border-color:#fecaca;
      background:#fff5f5;
    }
    .fav-btn.active i{ color:var(--red); }

    .product-img{
      background:var(--muted);
      border-radius:14px;
      padding:1rem;
      margin:.9rem 0 1rem;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:170px;
    }
    .product-img img{ max-height:140px; width:auto; }

    .product h3{
      color:var(--navy);
      font-size:1.12rem;
      margin:.15rem 0 .35rem;
      font-weight:900;
    }
    .specs{ color:#586170; font-weight:700; font-size:.92rem; }
    .price{
      margin:.75rem 0 1rem;
      font-weight:900;
      color:var(--blue);
      font-size:1.15rem;
    }

    .add-cart{
      margin-top:auto;
      width:100%;
      border:none;
      background:var(--navy);
      color:#fff;
      padding:.85rem 1rem;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.6rem;
      transition:.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .add-cart:hover{ background:var(--blue); transform:translateY(-1px); }

    /* ===== TOP TOAST (professional “cart appears at top”) ===== */
    .top-toast{
      position:fixed;
      top:74px;
      right:16px;
      z-index:2600;
      background:#0b1c2d;
      color:#fff;
      border-radius:14px;
      padding:.9rem 1rem;
      display:flex;
      align-items:center;
      gap:.75rem;
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      opacity:0;
      transform:translateY(-12px);
      pointer-events:none;
      transition:.25s;
      max-width:min(420px, 92vw);
    }
    .top-toast.show{
      opacity:1;
      transform:translateY(0);
    }
    .top-toast .pill{
      display:inline-flex;
      align-items:center;
      gap:.55rem;
      padding:.55rem .8rem;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      font-weight:900;
      white-space:nowrap;
    }
    .top-toast .actions{
      margin-left:auto;
      display:flex;
      gap:.5rem;
    }
    .top-toast .actions a{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.55rem .75rem;
      border-radius:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.2);
    }
    .top-toast .actions a:hover{ background:rgba(255,255,255,.08); }

    /* FOOTER */
    footer{
      background:var(--navy);
      color:#fff;
      padding:2.6rem 1.5rem;
    }
    footer .container{
      padding:0;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:1.6rem;
    }
    footer a{ color:#fff; text-decoration:underline; }
  </style>
</head>

<body>

<header>
  <div class="nav">
    <div class="brand">
      <a href="dashboard.html"><img src="logo.png" class="logo" alt="SATECH Logo"></a>
    </div>

    <!-- Desktop nav -->
    <nav class="nav-links" id="navLinks">
      <a href="dashboard.html">Home</a>
      <a href="ref.html">Refurbished</a>
      <a href="new.html">New</a>
      <a href="iphones.html">iPhones</a>
      <a href="acc.html">Accessories</a>
      <a href="repair.html">Repairs</a>
      <a href="contact.html">Contact</a>
    </nav>

    <!-- Actions -->
    <div class="nav-actions">
      <!-- favourites + cart must go to REAL pages -->
      <a class="icon-btn" id="favTopBtn" href="favorites.html" aria-label="Open favourites">
        <i class="fa-solid fa-heart"></i>
        <span class="badge red" id="favBadge">0</span>
      </a>

      <a class="icon-btn" id="cartTopBtn" href="cart.html" aria-label="Open cart">
        <i class="fa-solid fa-cart-shopping"></i>
        <span class="badge" id="cartBadge">0</span>
      </a>

      <div class="user-initials" id="userInitials" aria-label="User menu">U</div>
      <div class="user-menu" id="userMenu">
        <a href="account.html"><i class="fa-solid fa-gear"></i> Account Settings</a>
        <a href="orders.html"><i class="fa-solid fa-box"></i> My Orders</a>
        <a href="#" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
      </div>

      <button class="hamburger" id="hamburgerBtn" aria-label="Open menu" aria-expanded="false">
        <div class="hamburger-lines"><span></span><span></span><span></span></div>
      </button>
    </div>
  </div>
</header>

<!-- Mobile overlay + drawer -->
<div class="overlay" id="overlay"></div>

<aside class="mobile-drawer" id="drawer" aria-hidden="true">
  <div class="drawer-head">
    <strong>Menu</strong>
    <button class="drawer-close" id="drawerClose" aria-label="Close menu">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <div class="drawer-body">
    <a class="drawer-link" href="dashboard.html"><span><i class="fa-solid fa-house"></i> Home</span><i class="fa-solid fa-chevron-right"></i></a>
    <a class="drawer-link" href="ref.html"><span><i class="fa-solid fa-laptop"></i> Refurbished</span><i class="fa-solid fa-chevron-right"></i></a>
    <a class="drawer-link" href="new.html"><span><i class="fa-solid fa-laptop-code"></i> New Laptops</span><i class="fa-solid fa-chevron-right"></i></a>
    <a class="drawer-link" href="iphones.html"><span><i class="fa-brands fa-apple"></i> iPhones</span><i class="fa-solid fa-chevron-right"></i></a>
    <a class="drawer-link" href="acc.html"><span><i class="fa-solid fa-headphones"></i> Accessories</span><i class="fa-solid fa-chevron-right"></i></a>
    <a class="drawer-link" href="repair.html"><span><i class="fa-solid fa-screwdriver-wrench"></i> Repairs</span><i class="fa-solid fa-chevron-right"></i></a>
    <a class="drawer-link" href="contact.html"><span><i class="fa-solid fa-envelope"></i> Contact</span><i class="fa-solid fa-chevron-right"></i></a>

    <a class="drawer-link" href="favorites.html"><span><i class="fa-solid fa-heart"></i> Favourites</span><i class="fa-solid fa-chevron-right"></i></a>
    <a class="drawer-link" href="cart.html"><span><i class="fa-solid fa-cart-shopping"></i> Cart</span><i class="fa-solid fa-chevron-right"></i></a>

    <a class="drawer-link" href="#" id="logoutMobile" style="border-color:#fecaca;background:#fff5f5;">
      <span><i class="fa-solid fa-right-from-bracket" style="color:var(--red)"></i> Logout</span>
      <i class="fa-solid fa-chevron-right"></i>
    </a>
  </div>

  <div class="drawer-footer">
    SATECH ENTERPRISE, New laptops, refurbished deals & reliable repairs.
  </div>
</aside>

<!-- Top toast (cart appears at top when adding) -->
<div class="top-toast" id="topToast" aria-live="polite">
  <div class="pill" id="toastText"><i class="fa-solid fa-check"></i> Added to cart</div>
  <div class="actions">
    <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i>&nbsp;View</a>
  </div>
</div>

<section class="page-header">
  <div class="hero-container">
    <div class="hero-text">
      <h1>Brand New Laptops</h1>
      <p>Modern, reliable laptops for work, school & business,  with warranty-ready options.</p>
    </div>
    <div class="hero-image">
      <img src="new.png" alt="New Laptops">
    </div>
  </div>
</section>

<main class="container">
  <h2 class="section-title">Available New Laptops</h2>

  <div class="products">
    <!-- Product 1 -->
    <div class="product" data-code="HP001" data-name="HP Pavilion i5" data-price="13999" data-img="newlaptops4.png">
      <div class="product-top">
        <div></div>
        <button class="fav-btn" aria-label="Add to favourites" onclick="toggleFavouriteFromCard(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
      <div class="product-img"><img src="newlaptops4.png" alt="HP Pavilion i5"></div>
      <h3>HP Pavilion i5</h3>
      <div class="specs">Intel Core i5 • 8GB RAM • 512GB SSD</div>
      <div class="price">R13,999</div>
      <button class="add-cart" onclick="addToCartFromCard(this)">
        <i class="fa-solid fa-cart-plus"></i> Add to Cart
      </button>
    </div>

    <!-- Product 2 -->
    <div class="product" data-code="DE001" data-name="Dell Inspiron i7" data-price="16999" data-img="newlaptops6.png">
      <div class="product-top">
        <div></div>
        <button class="fav-btn" aria-label="Add to favourites" onclick="toggleFavouriteFromCard(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
      <div class="product-img"><img src="newlaptops6.png" alt="Dell Inspiron i7"></div>
      <h3>Dell Inspiron i7</h3>
      <div class="specs">Intel Core i7 • 16GB RAM • 512GB SSD</div>
      <div class="price">R16,999</div>
      <button class="add-cart" onclick="addToCartFromCard(this)">
        <i class="fa-solid fa-cart-plus"></i> Add to Cart
      </button>
    </div>

    <!-- Product 3 -->
    <div class="product" data-code="LE001" data-name="Lenovo IdeaPad Ryzen 5" data-price="12499" data-img="newlaptops5.png">
      <div class="product-top">
        <div></div>
        <button class="fav-btn" aria-label="Add to favourites" onclick="toggleFavouriteFromCard(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
      <div class="product-img"><img src="newlaptops5.png" alt="Lenovo IdeaPad Ryzen 5"></div>
      <h3>Lenovo IdeaPad Ryzen 5</h3>
      <div class="specs">Ryzen 5 • 8GB RAM • 512GB SSD</div>
      <div class="price">R12,499</div>
      <button class="add-cart" onclick="addToCartFromCard(this)">
        <i class="fa-solid fa-cart-plus"></i> Add to Cart
      </button>
    </div>

    <!-- Product 4 -->
    <div class="product" data-code="AS001" data-name="ASUS VivoBook i5" data-price="11999" data-img="newlaptops8.png">
      <div class="product-top">
        <div></div>
        <button class="fav-btn" aria-label="Add to favourites" onclick="toggleFavouriteFromCard(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
      <div class="product-img"><img src="newlaptops8.png" alt="ASUS VivoBook i5"></div>
      <h3>ASUS VivoBook i5</h3>
      <div class="specs">Intel Core i5 • 8GB RAM • 512GB SSD</div>
      <div class="price">R11,999</div>
      <button class="add-cart" onclick="addToCartFromCard(this)">
        <i class="fa-solid fa-cart-plus"></i> Add to Cart
      </button>
    </div>

    <!-- Product 5 -->
    <div class="product" data-code="AC001" data-name="Acer Aspire 7 Gaming" data-price="17999" data-img="newlaptops2.png">
      <div class="product-top">
        <div></div>
        <button class="fav-btn" aria-label="Add to favourites" onclick="toggleFavouriteFromCard(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
      <div class="product-img"><img src="newlaptops2.png" alt="Acer Aspire 7 Gaming"></div>
      <h3>Acer Aspire 7 Gaming</h3>
      <div class="specs">Ryzen 5 / i5 • 16GB RAM • 512GB SSD</div>
      <div class="price">R17,999</div>
      <button class="add-cart" onclick="addToCartFromCard(this)">
        <i class="fa-solid fa-cart-plus"></i> Add to Cart
      </button>
    </div>

    <!-- Product 6 -->
    <div class="product" data-code="MB001" data-name="MacBook Air M1" data-price="18999" data-img="newlaptops7.png">
      <div class="product-top">
        <div></div>
        <button class="fav-btn" aria-label="Add to favourites" onclick="toggleFavouriteFromCard(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
      <div class="product-img"><img src="newlaptops7.png" alt="MacBook Air M1"></div>
      <h3>MacBook Air M1</h3>
      <div class="specs">Apple M1 • 8GB RAM • 256GB SSD</div>
      <div class="price">R18,999</div>
      <button class="add-cart" onclick="addToCartFromCard(this)">
        <i class="fa-solid fa-cart-plus"></i> Add to Cart
      </button>
    </div>

    <!-- Product 7 -->
    <div class="product" data-code="MS001" data-name="MSI Modern 15" data-price="14499" data-img="newlaptops1.png">
      <div class="product-top">
        <div></div>
        <button class="fav-btn" aria-label="Add to favourites" onclick="toggleFavouriteFromCard(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
      <div class="product-img"><img src="newlaptops1.png" alt="MSI Modern 15"></div>
      <h3>MSI Modern 15</h3>
      <div class="specs">Intel Core i5 • 8GB RAM • 512GB SSD</div>
      <div class="price">R14,499</div>
      <button class="add-cart" onclick="addToCartFromCard(this)">
        <i class="fa-solid fa-cart-plus"></i> Add to Cart
      </button>
    </div>

    <!-- Product 8 -->
    <div class="product" data-code="HU001" data-name="Huawei MateBook D15" data-price="12999" data-img="newlaptops3.png">
      <div class="product-top">
        <div></div>
        <button class="fav-btn" aria-label="Add to favourites" onclick="toggleFavouriteFromCard(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
      </div>
      <div class="product-img"><img src="newlaptops3.png" alt="Huawei MateBook D15"></div>
      <h3>Huawei MateBook D15</h3>
      <div class="specs">Intel Core i5 • 8GB RAM • 512GB SSD</div>
      <div class="price">R12,999</div>
      <button class="add-cart" onclick="addToCartFromCard(this)">
        <i class="fa-solid fa-cart-plus"></i> Add to Cart
      </button>
    </div>

  </div>
</main>

<footer>
  <div class="container">
    <div>
      <h3>SATECH ENTERPRISE</h3>
      <p>Powered by <a href="https://cmstudio.online" target="_blank" rel="noopener noreferrer">CMSTUDIO</a></p>
    </div>
    <div>
      <h4>Quick Links</h4>
      <p>Shop • Repairs • Support</p>
    </div>
    <div>
      <h4>Secure Payments</h4>
      <p>Card • EFT • PayFast (Coming Soon)</p>
    </div>
  </div>
</footer>

<script>
  // ===== Supabase =====
  const supabaseClient = supabase.createClient(
    "https://nzuwmiyduragtqyaetfr.supabase.co",
    "sb_publishable_0VN3EDApVH9bzKu2eH7fvg_5JfYOGMh"
  );

  const LOGIN_PAGE = "login.html";

  async function requireAuth() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      window.location.href = LOGIN_PAGE;
      return null;
    }
    return session;
  }

  supabaseClient.auth.onAuthStateChange((event) => {
    if (event === "SIGNED_OUT" || event === "USER_DELETED" || event === "TOKEN_REFRESH_FAILED") {
      window.location.href = LOGIN_PAGE;
    }
  });

  // ===== Local storage helpers =====
  const CART_KEY = "cart";
  const FAV_KEY = "favourites";

  function getCart() {
    try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
    catch { return []; }
  }

  function saveCart(cart) {
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }

  function getFavs() {
    try { return JSON.parse(localStorage.getItem(FAV_KEY)) || []; }
    catch { return []; }
  }

  function saveFavs(favs) {
    localStorage.setItem(FAV_KEY, JSON.stringify(favs));
  }

  function cartCount() {
    return getCart().reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
  }

  function favCount() {
    return getFavs().length;
  }

  function updateBadges() {
    document.getElementById("cartBadge").textContent = String(cartCount());
    document.getElementById("favBadge").textContent = String(favCount());
  }

  // ===== User initials + dropdown =====
  const userInitials = document.getElementById("userInitials");
  const userMenu = document.getElementById("userMenu");

  async function loadUser() {
    const session = await requireAuth();
    if (!session) return;

    const user = session.user;
    const { data: profile } = await supabaseClient
      .from("profiles")
      .select("full_names,surname")
      .eq("id", user.id)
      .maybeSingle();

    if (profile?.full_names && profile?.surname) {
      const initials = (profile.full_names[0] || "U") + (profile.surname[0] || "");
      userInitials.textContent = initials.toUpperCase();
    } else {
      userInitials.textContent = "U";
    }
  }

  userInitials.addEventListener("click", (e) => {
    e.stopPropagation();
    userMenu.style.display = (userMenu.style.display === "block") ? "none" : "block";
  });

  document.addEventListener("click", () => {
    userMenu.style.display = "none";
  });

  // ===== Drawer (Hamburger) — Dashboard style & reliable =====
  const hamburgerBtn = document.getElementById("hamburgerBtn");
  const drawer = document.getElementById("drawer");
  const overlay = document.getElementById("overlay");
  const drawerClose = document.getElementById("drawerClose");

  function openDrawer() {
    drawer.classList.add("show");
    overlay.classList.add("show");
    hamburgerBtn.classList.add("active");
    hamburgerBtn.setAttribute("aria-expanded", "true");
    drawer.setAttribute("aria-hidden", "false");
    document.body.classList.add("no-scroll");
  }

  function closeDrawer() {
    drawer.classList.remove("show");
    overlay.classList.remove("show");
    hamburgerBtn.classList.remove("active");
    hamburgerBtn.setAttribute("aria-expanded", "false");
    drawer.setAttribute("aria-hidden", "true");
    document.body.classList.remove("no-scroll");
  }

  function toggleDrawer(e) {
    e.preventDefault();
    e.stopPropagation();
    drawer.classList.contains("show") ? closeDrawer() : openDrawer();
  }

  // IMPORTANT: only click (touchstart can double-fire on some phones)
  hamburgerBtn.addEventListener("click", toggleDrawer);
  overlay.addEventListener("click", closeDrawer);
  drawerClose.addEventListener("click", closeDrawer);
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && drawer.classList.contains("show")) closeDrawer();
  });
  drawer.querySelectorAll("a").forEach(a => a.addEventListener("click", closeDrawer));

  // ===== Logout =====
  async function doLogout(e) {
    if (e) e.preventDefault();
    await supabaseClient.auth.signOut();
    window.location.href = LOGIN_PAGE;
  }
  document.getElementById("logoutBtn").addEventListener("click", doLogout);
  document.getElementById("logoutMobile").addEventListener("click", doLogout);

  // ===== Favourites: toggle + sync UI =====
  function isFaved(code) {
    return getFavs().some(x => x.code === code);
  }

  function syncFavButtons() {
    document.querySelectorAll(".product").forEach(card => {
      const code = card.dataset.code;
      const btn = card.querySelector(".fav-btn");
      if (!btn) return;
      btn.classList.toggle("active", isFaved(code));
    });
  }

  function toggleFavouriteFromCard(buttonEl) {
    const card = buttonEl.closest(".product");
    if (!card) return;

    const item = {
      code: card.dataset.code,
      name: card.dataset.name,
      price: Number(card.dataset.price || 0),
      img: card.dataset.img
    };

    let favs = getFavs();
    const idx = favs.findIndex(x => x.code === item.code);

    if (idx >= 0) favs.splice(idx, 1);
    else favs.push(item);

    saveFavs(favs);
    updateBadges();
    syncFavButtons();
  }

  // ===== Cart: add + top toast =====
  const topToast = document.getElementById("topToast");
  const toastText = document.getElementById("toastText");
  let toastTimer = null;

  function showTopToast(message) {
    toastText.innerHTML = `<i class="fa-solid fa-check"></i> ${message}`;
    topToast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => topToast.classList.remove("show"), 2500);
  }

  function addToCartFromCard(btnEl) {
    const card = btnEl.closest(".product");
    if (!card) return;

    const item = {
      code: card.dataset.code,
      name: card.dataset.name,
      price: Number(card.dataset.price || 0),
      img: card.dataset.img
    };

    let cart = getCart();
    const existing = cart.find(p => p.code === item.code);
    if (existing) existing.qty = (Number(existing.qty) || 0) + 1;
    else cart.push({ ...item, qty: 1 });

    saveCart(cart);
    updateBadges();
    showTopToast(`${item.name} added to cart`);
  }

  // ===== Init =====
  (async function init() {
    await loadUser();
    updateBadges();
    syncFavButtons();
  })();
</script>

</body>
</html>
